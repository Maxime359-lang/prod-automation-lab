name: Deploy to EC2 (SSM + OIDC)

on:
  workflow_run:
    workflows: ["Build & Push Image"]
    types: [completed]

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-ec2
  cancel-in-progress: true

jobs:
  deploy:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: eu-central-1

      - name: Deploy via SSM Run Command
        env:
          SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail

          aws ssm send-command \
            --instance-ids "${{ secrets.AWS_EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy prod-automation SHA=${SHA}" \
            --parameters commands="[
              \"set -euo pipefail\",
              \"mkdir -p ~/prod-automation\",
              \"sudo dnf install -y docker-compose-plugin curl >/dev/null 2>&1 || true\",
              \"curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${SHA}/docker-compose.prod.yml -o ~/prod-automation/docker-compose.prod.yml\",
              \"docker rm -f prod-automation 2>/dev/null || true\",
              \"cd ~/prod-automation\",
              \"export IMAGE_TAG=${SHA}\",
              \"docker compose -f docker-compose.prod.yml pull\",
              \"docker compose -f docker-compose.prod.yml up -d --remove-orphans\",
              \"docker ps --format 'table {{.Names}}\\t{{.Image}}\\t{{.Ports}}\\t{{.Status}}'\"
            ]"
