name: Deploy to EC2 (Docker Compose)

on:
  workflow_run:
    workflows: ["Build & Push Image"]
    types: [completed]

permissions:
  contents: read

concurrency:
  group: deploy-ec2
  cancel-in-progress: true

jobs:
  deploy:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout same commit that was built
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Write SSH key
        run: |
          install -m 700 -d ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Copy compose to EC2
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ~/prod-automation"
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            docker-compose.prod.yml \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/prod-automation/docker-compose.prod.yml

      - name: Deploy on EC2
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'SSH'
            set -euo pipefail
            cd ~/prod-automation

            export IMAGE_TAG='${{ github.event.workflow_run.head_sha }}'

            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --remove-orphans

            echo "=== containers ==="
            docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Ports}}\t{{.Status}}'
          SSH
