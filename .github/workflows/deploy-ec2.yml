name: Deploy to EC2 (SSM + OIDC)

on:
  workflow_run:
    workflows: ["Build & Push Image"]
    types: [completed]

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-ec2
  cancel-in-progress: true

jobs:
  deploy:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: eu-central-1

      - name: Deploy via SSM Run Command
        env:
          SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail

          CMD_ID=$(aws ssm send-command \
            --targets "Key=tag:SSMDeploy,Values=prod-automation" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy prod-automation SHA=${SHA}" \
            --query "Command.CommandId" \
            --output text \
            --parameters commands="[
              \"set -euo pipefail\",
              \"sudo dnf install -y docker-compose-plugin curl >/dev/null 2>&1 || true\",
              \"sudo -u ec2-user mkdir -p /home/ec2-user/prod-automation\",
              \"sudo -u ec2-user curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${SHA}/docker-compose.prod.yml -o /home/ec2-user/prod-automation/docker-compose.prod.yml\",
              \"sudo docker rm -f prod-automation 2>/dev/null || true\",
              \"runuser -l ec2-user -c 'cd /home/ec2-user/prod-automation && export IMAGE_TAG=${SHA} && docker compose -f docker-compose.prod.yml pull'\",
              \"runuser -l ec2-user -c 'cd /home/ec2-user/prod-automation && export IMAGE_TAG=${SHA} && docker compose -f docker-compose.prod.yml up -d --remove-orphans'\",
              \"tries=0; until curl -fsS http://127.0.0.1:8081/health; do tries=\\$((tries+1)); if [ \\$tries -ge 30 ]; then echo SMOKE_FAIL; docker logs --tail=200 prod-automation || true; exit 1; fi; echo SMOKE_retry_\\$tries; sleep 2; done; echo SMOKE_OK\",
              \"docker ps --format 'table {{.Names}}\\\\t{{.Image}}\\\\t{{.Ports}}\\\\t{{.Status}}'\"
            ]")

          echo "SSM CommandId: $CMD_ID"

          aws ssm wait command-executed \
            --command-id "$CMD_ID" \
            --instance-id "${{ secrets.AWS_EC2_INSTANCE_ID }}"

          aws ssm get-command-invocation \
            --command-id "$CMD_ID" \
            --instance-id "${{ secrets.AWS_EC2_INSTANCE_ID }}" \
            --query "{Status:Status,Stdout:StandardOutputContent,Stderr:StandardErrorContent,ResponseCode:ResponseCode}" \
            --output json
